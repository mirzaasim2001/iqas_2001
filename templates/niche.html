{% extends "base.html" %}
{% block content %}

<div class="page-header">
    <h1>{{ niche | capitalize }} Trends</h1>
</div>

<div class="niche-layout">

    <!-- SUB NICHE SIDEBAR -->
    <aside class="sub-niche-panel">
        {% for s in sub_niches %}
        <a href="/niche/{{ niche }}?sub={{ s }}"
           class="{% if s == active_sub %}active{% endif %}">
            {{ s | capitalize }}
        </a>
        {% endfor %}
    </aside>

    <!-- MAIN CONTENT -->
    <div class="niche-main">

        <!-- FILTER -->
        <div class="niche-filter">
            <div class="filter-box">

                <div class="filter-row">
                    <label for="priceFilter">Sort by price</label>
                    <select id="priceFilter">
                        <option value="">Default</option>
                        <option value="low-high">Low â†’ High</option>
                        <option value="high-low">High â†’ Low</option>
                    </select>
                </div>

                <div class="filter-row range-row">
                    <label>Price range</label>
                    <input
                        type="range"
                        id="priceRange"
                        min="0"
                        max="100000"
                        step="500"
                        value="100000"
                    >
                    <span id="rangeValue">â‚¹1,00,000+</span>
                </div>

            </div>
        </div>

        <!-- PRODUCTS -->
        <section class="grid niche-products" id="productGrid">
            {% for product in products %}
            <div class="product-card">
                <a href="/niche/{{ niche }}/{{ product.id }}" class="product-link">
                    <img src="{{ product.image }}" alt="{{ product.title }}">
                    <h4>{{ product.title }}</h4>
                </a>
                <p class="product-price">{{ product.price }}</p>
            </div>
            {% endfor %}
        </section>
        <div id="pagination" class="pagination"></div>


    </div>
</div>

<script>
const PRODUCTS_PER_PAGE = 9;
let currentPage = 1;

function extractPrice(text) {
    return parseFloat(text.replace(/[â‚¹, ]/g, "")) || 0;
}

const grid = document.getElementById("productGrid");
let cards = Array.from(grid.children);
const pagination = document.getElementById("pagination");

/* ---------------- PAGINATION ---------------- */

function showPage(page) {
    currentPage = page;

    const start = (page - 1) * PRODUCTS_PER_PAGE;
    const end = page * PRODUCTS_PER_PAGE;

    cards.forEach((card, index) => {
        card.style.display =
            index >= start && index < end ? "block" : "none";
    });

    renderPagination();

    // ðŸ”½ Scroll to top of products
    document.getElementById("productGrid")
        .scrollIntoView({ behavior: "smooth", block: "start" });
}


function renderPagination() {
    pagination.innerHTML = "";

    const totalPages = Math.ceil(cards.length / PRODUCTS_PER_PAGE);

    // Title
    const title = document.createElement("span");
    title.className = "pagination-title";
    title.innerText = "Page";
    pagination.appendChild(title);

    // Previous button
    const prevBtn = document.createElement("button");
    prevBtn.innerHTML = "â†";
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => showPage(currentPage - 1);
    pagination.appendChild(prevBtn);

    // Page numbers (always at least 1)
    for (let i = 1; i <= Math.max(totalPages, 1); i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.classList.toggle("active", i === currentPage);
        btn.onclick = () => showPage(i);
        pagination.appendChild(btn);
    }

    // Next button
    const nextBtn = document.createElement("button");
    nextBtn.innerHTML = "â†’";
    nextBtn.disabled = currentPage === totalPages || totalPages === 1;
    nextBtn.onclick = () => showPage(currentPage + 1);
    pagination.appendChild(nextBtn);
}



/* ---------------- SORT ---------------- */

document.getElementById("priceFilter").addEventListener("change", function () {
    const mode = this.value;
    if (!mode) return;

    cards.sort((a, b) => {
        const priceA = extractPrice(a.querySelector(".product-price").innerText);
        const priceB = extractPrice(b.querySelector(".product-price").innerText);
        return mode === "low-high" ? priceA - priceB : priceB - priceA;
    });

    cards.forEach(card => grid.appendChild(card));
    showPage(1); // reset to page 1 after sort
});

/* ---------------- RANGE FILTER ---------------- */

const range = document.getElementById("priceRange");
const rangeValue = document.getElementById("rangeValue");
const MAX_PRICE = parseInt(range.max);

range.addEventListener("input", function () {
    const maxPrice = parseInt(this.value);

    rangeValue.innerText =
        maxPrice === MAX_PRICE
            ? "â‚¹1,00,000+"
            : `Up to â‚¹${maxPrice.toLocaleString("en-IN")}`;

    cards = Array.from(grid.children).filter(card => {
        const price = extractPrice(card.querySelector(".product-price").innerText);
        return price <= maxPrice;
    });

    Array.from(grid.children).forEach(card => {
        const price = extractPrice(card.querySelector(".product-price").innerText);
        card.style.display = price <= maxPrice ? "block" : "none";
    });

    showPage(1);
});

/* ---------------- INITIAL LOAD ---------------- */
showPage(1);
</script>

{% endblock %}
