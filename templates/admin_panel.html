{% extends "base.html" %}
{% block content %}

<section class="admin-panel">
    <h1>Admin Panel</h1>
    <!-- ================= ADD NICHE ================= -->
    <h3>Add New Niche</h3>
    <form method="post" action="/admin/iqra928374asimsecret/add-niche">
        <input type="text" name="niche" placeholder="e.g. electronics" required>
        <input type="text" name="logo" placeholder="Niche Logo URL (optional)">
        <button>Add Niche</button>
    </form>

    <!-- ================= MANAGE NICHES ================= -->
    <h3>Manage Niches</h3>

    {% for niche in niches %}
    <div class="admin-niche">

        <strong>{{ niche.name | capitalize }}</strong>

        <!-- RENAME NICHE -->
        <form method="post" action="/admin/iqra928374asimsecret/edit-niche" class="inline-form">
            <input type="hidden" name="old_niche" value="{{ niche.name }}">
            <input type="text" name="new_niche" placeholder="Rename niche" required>
            <button>Rename</button>
        </form>

        <!-- UPDATE NICHE LOGO -->
        <form method="post" action="/admin/iqra928374asimsecret/update-niche-logo" class="inline-form">
            <input type="hidden" name="niche" value="{{ niche.name }}">
            <input
                type="text"
                name="logo"
                placeholder="Niche logo URL (optional)"
                value="{{ niche.logo or '' }}"
            >
            <button>Save Logo</button>
        </form>

        <!-- ADD SUB NICHE -->
        <form method="post" action="/admin/iqra928374asimsecret/add-sub-niche" class="inline-form">
            <input type="hidden" name="niche" value="{{ niche.name }}">
            <input type="text" name="sub_niche" placeholder="e.g. phone" required>
            <button>Add Sub-Niche</button>
        </form>

        <!-- EXISTING SUB NICHES + DELETE -->
        {% if sub_niches.get(niche.name) %}
        <ul class="sub-niche-list">
            {% for sn in sub_niches[niche.name] %}
            <li>
                {{ sn | capitalize }}
                <a
                    href="/admin/iqra928374asimsecret/delete-sub-niche/{{ niche.name }}/{{ sn }}"
                    class="danger"
                    onclick="return confirm('Delete sub-niche? Products will move to All.')"
                >
                    ‚úï
                </a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        <!-- DELETE NICHE -->
        <a
            href="/admin/iqra928374asimsecret/delete-niche/{{ niche.name }}"
            class="danger"
            onclick="return confirmDeleteNiche('{{ niche.name }}')"
        >
            Delete Niche
        </a>


    </div>
    {% endfor %}

    <!-- ================= MANAGE PRODUCTS ================= -->
    <h3>Manage Products by Niche</h3>

    {% for niche, items in products.items() %}
    <div class="admin-niche-block">

        <h4>{{ niche | capitalize }}</h4>

        <!-- ADD PRODUCT -->
        <form method="post" action="/admin/iqra928374asimsecret/add-product" class="inline-add-form">
            <input type="hidden" name="niche" value="{{ niche }}">
            <input type="text" name="title" placeholder="Product title" required>
            <input type="text" name="price" placeholder="Price" required>
            <input type="text" name="image" placeholder="Main Image URL" required>
            <input type="text" name="link" placeholder="Affiliate link" required>
            <input type="text"
       name="youtube_url"
       placeholder="YouTube video link (optional)">
            <button>Add Product</button>
        </form>

        {% if items %}
            {% for product in items %}
            <div class="admin-product">

                <img src="{{ product.image }}" alt="">

                <div class="admin-product-info">
                    <strong>{{ product.title }}</strong>
                    <p>{{ product.price }}</p>

                    <!-- ASSIGN SUB NICHE -->
                    <form method="post" action="/admin/iqra928374asimsecret/set-sub-niche">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <select name="sub_niche" onchange="this.form.submit()">
                            <option value="all" {% if product.sub_niche == "all" %}selected{% endif %}>
                                All
                            </option>

                            {% for sn in sub_niches.get(niche, []) %}
                                <option value="{{ sn }}"
                                    {% if product.sub_niche == sn %}selected{% endif %}>
                                    {{ sn | capitalize }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>

                    <!-- BEST PRODUCT -->
                    <a href="/admin/iqra928374asimsecret/toggle-best/{{ product.id }}">
                        {% if product.is_best %}
                            üèÜ Remove Best
                        {% else %}
                            üèÜ Set as Best
                        {% endif %}
                    </a>

                    <!-- FEATURE -->
                    <a href="/admin/iqra928374asimsecret/toggle-feature/{{ product.id }}">
                        {% if product.is_featured %}
                            ‚≠ê Unfeature
                        {% else %}
                            ‚òÜ Feature
                        {% endif %}
                    </a>

                    <a href="/admin/iqra928374asimsecret/edit-product/{{ niche }}/{{ product.id }}">
                        Edit Full Details
                    </a>

                    <a
                        href="/admin/iqra928374asimsecret/delete-product/{{ niche }}/{{ product.id }}"
                        class="danger"
                        onclick="return confirm('Delete this product?')"
                    >
                        Delete
                    </a>
                </div>

            </div>
            {% endfor %}
        {% else %}
            <p class="muted">No products yet.</p>
        {% endif %}

    </div>
    {% endfor %}

    <a class="logout" href="/logout">Logout</a>

</section>
<script>
function confirmDeleteNiche(nicheName) {
    const input = prompt(
        "‚ö†Ô∏è This action is irreversible.\n\nType 'delete' to permanently delete the niche: " + nicheName
    );

    if (input === null) {
        return false; // user cancelled
    }

    if (input.trim().toLowerCase() !== "delete") {
        alert("Deletion cancelled. You must type 'delete' exactly.");
        return false;
    }

    return true; // allow deletion
}
</script>



{% endblock %}
